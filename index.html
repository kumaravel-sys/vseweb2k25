<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VSE Stock Simulator</title>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.30.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family: Arial; margin:0; padding:0; background:#f5f7fb; }
.login-container, .dashboard, .admin-panel { display:none; padding:20px; }
input, button { padding:10px; margin:5px; }
#stock-list { max-height:150px; overflow:auto; border:1px solid #ccc; }
table { width:100%; border-collapse: collapse; }
th, td { border:1px solid #ccc; padding:8px; text-align:center; }
</style>
</head>
<body>

<!-- LOGIN PAGE -->
<div class="login-container" id="login-page">
  <h2>VSE Stock Simulator Login</h2>
  <input type="email" id="email" placeholder="Email"><br>
  <input type="password" id="password" placeholder="Password"><br>
  <button id="login-btn">Login / Register</button>
  <p id="login-msg" style="color:red;"></p>
</div>

<!-- DASHBOARD PAGE -->
<div class="dashboard" id="dashboard">
  <h2>Welcome, <span id="user-name"></span></h2>
  <button id="logout-btn">Logout</button>

  <h3>Search Stock:</h3>
  <input type="text" id="stock-search" placeholder="Type NSE stock name or symbol">
  <div id="stock-list"></div>

  <h3 id="stock-title"></h3>
  <canvas id="stock-chart" width="600" height="300"></canvas>

  <h3>Buy / Sell</h3>
  <input type="number" id="trade-qty" placeholder="Quantity">
  <button id="buy-btn">Buy</button>
  <button id="sell-btn">Sell</button>

  <h3>Portfolio</h3>
  <table id="portfolio-table">
    <thead><tr><th>Stock</th><th>Qty</th><th>Avg Price</th><th>Current Price</th><th>Value</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>Balance: â‚¹<span id="balance"></span></h3>

  <h3>Top Gainers</h3>
  <table id="gainers-table">
    <thead><tr><th>Stock</th><th>Price</th><th>Change %</th></tr></thead>
    <tbody></tbody>
  </table>

  <h3>Top Losers</h3>
  <table id="losers-table">
    <thead><tr><th>Stock</th><th>Price</th><th>Change %</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<!-- ADMIN PANEL -->
<div class="admin-panel" id="admin-panel">
  <h2>Admin Panel</h2>
  <button id="admin-logout-btn">Logout</button>
  <h3>Users</h3>
  <table id="users-table">
    <thead><tr><th>Email</th><th>Balance</th><th>Portfolio</th><th>Pending Orders</th></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDr_yQFo5DGNIBpAfOezVYyMd-wtiDwN9c",
  authDomain: "myweb-cd0a2.firebaseapp.com",
  projectId: "myweb-cd0a2",
  storageBucket: "myweb-cd0a2.firebasestorage.app",
  messagingSenderId: "896802835911",
  appId: "1:896802835911:web:4eca4c7c6fb7e516fb5de2"
};
const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const COMMON_PASSWORD = "vse2k25";
const ADMIN_EMAIL = "admin6@vse.com";
const ADMIN_PASSWORD = "adminvse2k25";

const loginPage = document.getElementById('login-page');
const dashboard = document.getElementById('dashboard');
const adminPanel = document.getElementById('admin-panel');
const loginMsg = document.getElementById('login-msg');

const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');

const logoutBtn = document.getElementById('logout-btn');
const adminLogoutBtn = document.getElementById('admin-logout-btn');

const stockSearch = document.getElementById('stock-search');
const stockList = document.getElementById('stock-list');
const stockTitle = document.getElementById('stock-title');

const portfolioTable = document.getElementById('portfolio-table').querySelector('tbody');
const gainersTable = document.getElementById('gainers-table').querySelector('tbody');
const losersTable = document.getElementById('losers-table').querySelector('tbody');
const usersTable = document.getElementById('users-table').querySelector('tbody');

const balanceDisplay = document.getElementById('balance');
const tradeQty = document.getElementById('trade-qty');
const buyBtn = document.getElementById('buy-btn');
const sellBtn = document.getElementById('sell-btn');

let currentUser = null;
let stockData = {}; // { symbol: { price:..., history: [...] } }
let chartInstance = null;
let currentSymbol = null;

// Demo NSE stock list (expandable)
const nseStocks = [
  { symbol: "RELIANCE", name: "Reliance Industries" },
  { symbol: "TCS", name: "Tata Consultancy Services" },
  { symbol: "INFY", name: "Infosys" },
  { symbol: "HDFC", name: "HDFC Bank" },
  { symbol: "ICICIBANK", name: "ICICI Bank" },
  { symbol: "LT", name: "Larsen & Toubro" },
  { symbol: "SBIN", name: "State Bank of India" },
  { symbol: "MARUTI", name: "Maruti Suzuki" }
];

// Initialize fake stock prices
nseStocks.forEach(stock => {
  stockData[stock.symbol] = { price: (Math.random()*5000 + 500).toFixed(2), history: [] };
});

// ---------------- LOGIN HANDLER ----------------
document.getElementById('login-btn').addEventListener('click', async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  loginMsg.innerText = '';

  if(email === ADMIN_EMAIL && password === ADMIN_PASSWORD){
    currentUser = { email: ADMIN_EMAIL, admin:true };
    showAdminPanel();
    return;
  }

  try {
    await auth.signInWithEmailAndPassword(email, password);
    currentUser = { email, admin:false };
  } catch(e){
    if(password === COMMON_PASSWORD){
      try{
        await auth.createUserWithEmailAndPassword(email, password);
        // Initialize user in Firestore with 50000 balance
        await db.collection("users").doc(email).set({
          balance: 50000,
          portfolio: {},
          pendingOrders: []
        });
        currentUser = { email, admin:false };
      }catch(err){
        loginMsg.innerText = "Error creating user!";
        return;
      }
    } else {
      loginMsg.innerText = "Invalid credentials!";
      return;
    }
  }

  showDashboard();
});

logoutBtn.addEventListener('click', ()=>{ location.reload(); });
adminLogoutBtn.addEventListener('click', ()=>{ location.reload(); });

// ---------------- DASHBOARD ----------------
async function showDashboard(){
  loginPage.style.display = 'none';
  dashboard.style.display = 'block';
  adminPanel.style.display = 'none';
  document.getElementById('user-name').innerText = currentUser.email.split("@")[0];

  await loadUserData();
  populateTopGainersLosers();
  simulateMarket();
}

// AUTOSUGGESTIONS
stockSearch.addEventListener('input', () => {
  const query = stockSearch.value.toUpperCase();
  stockList.innerHTML = '';
  if(query.length>0){
    const matches = nseStocks.filter(s => s.symbol.includes(query) || s.name.toUpperCase().includes(query));
    matches.forEach(s => {
      const div = document.createElement('div');
      div.innerText = `${s.symbol} - ${s.name}`;
      div.style.cursor = 'pointer';
      div.onclick = () => { showStockChart(s.symbol); stockList.innerHTML=''; stockSearch.value=''; };
      stockList.appendChild(div);
    });
  }
});

// SHOW STOCK CHART
function showStockChart(symbol){
  currentSymbol = symbol;
  stockTitle.innerText = symbol;
  if(!stockData[symbol].history.length){
    for(let i=0;i<50;i++){
      let price = parseFloat(stockData[symbol].price);
      price = (price + Math.random()*10 -5).toFixed(2);
      stockData[symbol].history.push(price);
    }
  }
  if(chartInstance) chartInstance.destroy();
  const ctx = document.getElementById('stock-chart').getContext('2d');
  chartInstance = new Chart(ctx, {
    type:'line',
    data:{
      labels:Array.from({length:stockData[symbol].history.length}, (_,i)=>i+1),
      datasets:[{
        label:symbol,
        data: stockData[symbol].history,
        borderColor:'green',
        fill:false
      }]
    },
    options:{ animation:false }
  });
}

// ---------------- MARKET SIMULATION ----------------
function simulateMarket(){
  setInterval(async ()=>{
    Object.keys(stockData).forEach(symbol=>{
      let last = parseFloat(stockData[symbol].history.slice(-1)[0] || stockData[symbol].price);
      let change = (Math.random()*10 -5);
      let newPrice = (last + change).toFixed(2);
      stockData[symbol].price = newPrice;
      stockData[symbol].history.push(newPrice);
      if(stockData[symbol].history.length>50) stockData[symbol].history.shift();

      if(currentSymbol === symbol && chartInstance){
        chartInstance.data.datasets[0].data = stockData[symbol].history;
        chartInstance.update();
      }
    });
    populateTopGainersLosers();
    updatePortfolioDisplay();
    await executePendingOrders();
  },2000);
}

// TOP GAINERS / LOSERS
function populateTopGainersLosers(){
  const arr = Object.keys(stockData).map(s => {
    let h = stockData[s].history;
    let change = ((parseFloat(h[h.length-1]) - parseFloat(h[0])) / parseFloat(h[0])*100).toFixed(2);
    return { symbol:s, price:stockData[s].price, change: parseFloat(change) };
  });
  const gainers = arr.sort((a,b)=>b.change - a.change).slice(0,5);
  const losers = arr.sort((a,b)=>a.change - b.change).slice(0,5);

  gainersTable.innerHTML = '';
  gainers.forEach(g=>{ gainersTable.innerHTML += `<tr><td>${g.symbol}</td><td>${g.price}</td><td>${g.change}%</td></tr>`; });

  losersTable.innerHTML = '';
  losers.forEach(l=>{ losersTable.innerHTML += `<tr><td>${l.symbol}</td><td>${l.price}</td><td>${l.change}%</td></tr>`; });
}

// ---------------- USER PORTFOLIO ----------------
let userData = null;
async function loadUserData(){
  const doc = await db.collection("users").doc(currentUser.email).get();
  if(doc.exists) userData = doc.data();
  updatePortfolioDisplay();
}

function updatePortfolioDisplay(){
  if(!userData) return;
  portfolioTable.innerHTML = '';
  let totalBalance = userData.balance;
  for(let s in userData.portfolio){
    let qty = userData.portfolio[s].qty;
    let avg = userData.portfolio[s].avgPrice;
    let current = stockData[s] ? stockData[s].price : 0;
    let val = (qty * current).toFixed(2);
    portfolioTable.innerHTML += `<tr>
      <td>${s}</td><td>${qty}</td><td>${avg}</td><td>${current}</td><td>${val}</td>
    </tr>`;
    totalBalance += parseFloat(val);
  }
  balanceDisplay.innerText = userData.balance.toFixed(2);
}

// ---------------- BUY / SELL ----------------
buyBtn.addEventListener('click', async ()=>{
  let qty = parseInt(tradeQty.value);
  if(!currentSymbol || !qty || qty<=0) return alert("Enter stock and qty");
  let price = parseFloat(stockData[currentSymbol].price);
  let total = qty*price;
  if(userData.balance >= total){
    // execute immediately
    userData.balance -= total;
    if(!userData.portfolio[currentSymbol]) userData.portfolio[currentSymbol] = { qty:0, avgPrice:0 };
    let oldQty = userData.portfolio[currentSymbol].qty;
    let oldAvg = userData.portfolio[currentSymbol].avgPrice;
    let newAvg = ((oldQty*oldAvg)+total)/(oldQty+qty);
    userData.portfolio[currentSymbol].qty += qty;
    userData.portfolio[currentSymbol].avgPrice = newAvg.toFixed(2);
    await db.collection("users").doc(currentUser.email).set(userData);
    updatePortfolioDisplay();
    tradeQty.value='';
  } else {
    alert("Insufficient balance!");
  }
});

sellBtn.addEventListener('click', async ()=>{
  let qty = parseInt(tradeQty.value);
  if(!currentSymbol || !qty || qty<=0) return alert("Enter stock and qty");
  if(!userData.portfolio[currentSymbol] || userData.portfolio[currentSymbol].qty < qty) return alert("Insufficient shares!");
  let price = parseFloat(stockData[currentSymbol].price);
  let total = qty*price;
  userData.balance += total;
  userData.portfolio[currentSymbol].qty -= qty;
  if(userData.portfolio[currentSymbol].qty===0) delete userData.portfolio[currentSymbol];
  await db.collection("users").doc(currentUser.email).set(userData);
  updatePortfolioDisplay();
  tradeQty.value='';
});

// ---------------- PENDING ORDERS SIMULATION ----------------
async function executePendingOrders(){
  // For simplicity, assume all pending orders execute immediately
  if(!userData || !userData.pendingOrders) return;
  let executed = [];
  for(let i=0;i<userData.pendingOrders.length;i++){
    let o = userData.pendingOrders[i];
    let price = parseFloat(stockData[o.symbol].price);
    if(o.type==='buy'){
      if(userData.balance >= o.qty*price){
        userData.balance -= o.qty*price;
        if(!userData.portfolio[o.symbol]) userData.portfolio[o.symbol] = { qty:0, avgPrice:0 };
        let oldQty = userData.portfolio[o.symbol].qty;
        let oldAvg = userData.portfolio[o.symbol].avgPrice;
        let newAvg = ((oldQty*oldAvg)+(o.qty*price))/(oldQty+o.qty);
        userData.portfolio[o.symbol].qty += o.qty;
        userData.portfolio[o.symbol].avgPrice = newAvg.toFixed(2);
        executed.push(i);
      }
    }
    if(o.type==='sell'){
      if(userData.portfolio[o.symbol] && userData.portfolio[o.symbol].qty>=o.qty){
        userData.balance += o.qty*price;
        userData.portfolio[o.symbol].qty -= o.qty;
        if(userData.portfolio[o.symbol].qty===0) delete userData.portfolio[o.symbol];
        executed.push(i);
      }
    }
  }
  // Remove executed orders
  executed.reverse().forEach(i=>userData.pendingOrders.splice(i,1));
  await db.collection("users").doc(currentUser.email).set(userData);
}

// ---------------- ADMIN PANEL ----------------
async function showAdminPanel(){
  loginPage.style.display = 'none';
  dashboard.style.display = 'none';
  adminPanel.style.display = 'block';
  await populateUsersTable();
}

async function populateUsersTable(){
  usersTable.innerHTML = '';
  const snapshot = await db.collection("users").get();
  snapshot.forEach(doc=>{
    const u = doc.data();
    usersTable.innerHTML += `<tr><td>${doc.id}</td><td>${u.balance.toFixed(2)}</td><td>${JSON.stringify(u.portfolio)}</td><td>${JSON.stringify(u.pendingOrders)}</td></tr>`;
  });
}
</script>

</body>
</html>
